{% extends "base.html" %}
{% block title %}HISTORY // FORGE{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold terminal-text">> LOG_HISTORY</h1>
    <div class="flex gap-2">
        <a href="?days=7" class="terminal-btn px-3 py-1 text-sm {% if days == 7 %}bg-green-900{% endif %}">7D</a>
        <a href="?days=14" class="terminal-btn px-3 py-1 text-sm {% if days == 14 %}bg-green-900{% endif %}">14D</a>
        <a href="?days=30" class="terminal-btn px-3 py-1 text-sm {% if days == 30 %}bg-green-900{% endif %}">30D</a>
    </div>
</div>

{% if history_by_date %}
<div class="space-y-4">
    {% for log_date, logs in history_by_date | dictsort(reverse=true) %}
    <div class="terminal-box p-4">
        <h3 class="text-sm text-green-700 mb-3 border-b border-green-900 pb-2">> {{ log_date }}</h3>

        {% set day_totals = namespace(cal=0, prot=0, carbs=0, fat=0, fiber=0, water=0) %}

        <div class="space-y-2">
            {% for log in logs %}
            {% set day_totals.cal = day_totals.cal + (log.calories or 0) %}
            {% set day_totals.prot = day_totals.prot + (log.protein_g or 0) %}
            {% set day_totals.carbs = day_totals.carbs + (log.carbs_g or 0) %}
            {% set day_totals.fat = day_totals.fat + (log.fat_g or 0) %}
            {% set day_totals.fiber = day_totals.fiber + (log.fiber_g or 0) %}
            {% set day_totals.water = day_totals.water + (log.water_oz or 0) %}

            <div class="flex justify-between items-center py-1 border-b border-green-900/30 text-sm group">
                <div class="flex items-center gap-3">
                    <span class="text-green-700 text-xs">{{ log.logged_at[11:16] if log.logged_at else '' }}</span>
                    <span class="terminal-text">{{ log.description }}</span>
                    {% if log.meal_type %}
                    <span class="text-xs text-green-700">[{{ log.meal_type | upper }}]</span>
                    {% endif %}
                </div>
                <div class="flex items-center gap-3">
                    <div class="text-xs text-green-600 space-x-2">
                        {% if log.calories %}<span>{{ log.calories }}cal</span>{% endif %}
                        {% if log.protein_g %}<span>{{ log.protein_g }}P</span>{% endif %}
                        {% if log.carbs_g %}<span>{{ log.carbs_g }}C</span>{% endif %}
                        {% if log.fat_g %}<span>{{ log.fat_g }}F</span>{% endif %}
                        {% if log.fiber_g %}<span>{{ log.fiber_g }}fib</span>{% endif %}
                        {% if log.water_oz %}<span class="text-cyan-400">{{ log.water_oz }}oz</span>{% endif %}
                    </div>
                    <button onclick="deleteEntry({{ log.id }}, '{{ log.description | e }}')"
                            class="text-red-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity text-xs px-2"
                            title="Delete entry">X</button>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Day Totals -->
        <div class="mt-3 pt-3 border-t border-green-700 flex justify-between text-sm">
            <span class="text-green-700">TOTAL:</span>
            <div class="text-green-400 space-x-3">
                <span>{{ day_totals.cal | round(0) | int }}cal</span>
                <span>{{ day_totals.prot | round(0) | int }}P</span>
                <span>{{ day_totals.carbs | round(0) | int }}C</span>
                <span>{{ day_totals.fat | round(0) | int }}F</span>
                <span>{{ day_totals.fiber | round(0) | int }}fib</span>
                {% if day_totals.water > 0 %}
                <span class="text-cyan-400">{{ day_totals.water | round(0) | int }}oz</span>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="terminal-box p-6 text-center">
    <p class="text-green-700">No logs found for the past {{ days }} days.</p>
    <a href="/" class="terminal-btn inline-block mt-4 px-4 py-2">> GO TO DASHBOARD</a>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
async function deleteEntry(id, description) {
    if (!confirm(`Delete "${description}"?`)) {
        return;
    }

    try {
        const response = await fetch(`/api/nutrition/${id}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to delete entry');
        }
    } catch (error) {
        console.error('Delete error:', error);
        alert('Failed to delete entry');
    }
}
</script>
{% endblock %}
